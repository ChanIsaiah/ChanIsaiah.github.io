<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Car Racing Game</title>
    <script src="libraries/p5.min.js"></script>
    <script src="libraries/p5.sound.min.js"></script>
    <style>
      html, body {
        margin: 0;
        height: 100%;
        background: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      canvas {
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0,0,0,0.6);
      }
      button {
        margin-top: 10px;
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        background: #ff4444;
        color: white;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover { background: #ff6666; }
    </style>
  </head>
  <body>
    <button id="musicBtn">Pause Music ‚è∏Ô∏è</button>

    <script>
      let player, enemy, obstacles = [];
      let powerUps = [];
      let roadImg, bgm, dejavu, crashSound, boosterSound;
      let playerImg, aeImg, gtrImg, redImg, taxiImg, boosterImg;
      let gameOver = false, gameWin = false;
      let lastSpawnTime = 0, lastSpeedIncrease = 0;
      let spawnInterval = 1200, obstacleSpeed = 5;
      let spawnCycle = 0, boostTimer = 0;
      let startTime, finishLineY = -100, finishDropped = false;

      let inGame = false;

      let playButton;
      let skinButton1, skinButton2, skinButton3;
      let currentPlayerImg;

      let musicPaused = false;

      function preload() {
        roadImg = loadImage('road.png');
        playerImg = loadImage('player.png');
        aeImg = loadImage('ae.png');
        gtrImg = loadImage('gtr.png');
        redImg = loadImage('red.png');
        taxiImg = loadImage('taxi.png');
        boosterImg = loadImage('booster.png');
        soundFormats('mp3');
        bgm = loadSound('racingCar.mp3');
        dejavu = loadSound('dejavu.mp3');
        crashSound = loadSound('crash.mp3');
        boosterSound = loadSound('booster.mp3');
        currentPlayerImg = playerImg;
      }

      function setup() {
        let canvas = createCanvas(600, 640);
        canvas.parent(document.body);
        resetGame();
        textAlign(CENTER, CENTER);

        const btn = document.getElementById('musicBtn');
        btn.addEventListener('click', () => {
          if (musicPaused) {
            musicPaused = false;
            btn.textContent = 'Pause Music ‚è∏Ô∏è';
            if (inGame && !bgm.isPlaying()) bgm.loop();
            if (inGame && !dejavu.isPlaying()) dejavu.loop();
          } else {
            musicPaused = true;
            btn.textContent = 'Play Music üéµ';
            if (bgm.isPlaying()) bgm.pause();
            if (dejavu.isPlaying()) dejavu.pause();
          }
        });

        playButton = createButton('Play');
        playButton.position(windowWidth / 2 - 40, height - 50);
        playButton.mousePressed(() => {
          inGame = true;
          hideButtons();
          hideCustomizeButtons();
          resetGame();

          // Play both bgms if not muted
          if (!musicPaused) {
            if (!bgm.isPlaying()) bgm.loop();
            if (!dejavu.isPlaying()) dejavu.loop();
          }
        });

        // Car selection buttons
        skinButton1 = createButton('Skyline');
        skinButton1.position(windowWidth / 2 - 175, height / 2);
        skinButton1.mousePressed(() => { currentPlayerImg = playerImg; });

        skinButton2 = createButton("AE86");
        skinButton2.position(windowWidth / 2 - 32.5, height / 2);
        skinButton2.mousePressed(() => { currentPlayerImg = aeImg; });

        skinButton3 = createButton("GTR");
        skinButton3.position(windowWidth / 2 + 100, height / 2);
        skinButton3.mousePressed(() => { currentPlayerImg = gtrImg; });

        fill(255);
      }

      function draw() {
        if(inGame) {
          gameLoop();
        }
        else {
          background(30);
          mainMenu();
        }
      }

      function gameLoop() {
        clear();
        imageMode(CORNER);
        if (roadImg) image(roadImg, 0, 0, width, height);
        else background(30);

        if (!gameOver && !gameWin) {
          player.update();
          player.display(currentPlayerImg);

          enemy.y = 200;
          proAvoidObstacles();
          enemy.update();
          enemy.display(redImg);

          // spawn obstacles
          if (millis() - lastSpawnTime > spawnInterval) {
            let xPos;
            if (spawnCycle === 0) xPos = random(60, width / 3);
            else if (spawnCycle === 1) xPos = random(width / 3, 2 * width / 3);
            else xPos = random(width - width / 3, width - 60);
            obstacles.push(new Car(xPos, -60, color(0, 100, 255)));
            spawnCycle = (spawnCycle + 1) % 3;
            lastSpawnTime = millis();
          }

          // increase difficulty + spawn booster
          if (millis() - lastSpeedIncrease > 5000) {
            obstacleSpeed += 0.5;
            spawnInterval = max(400, spawnInterval - 100);
            lastSpeedIncrease = millis();
            let px = random(60, width - 60);
            powerUps.push(new PowerUp(px, -50));
          }

          // move obstacles
          let alive = [];
          for (let obs of obstacles) {
            obs.y += obstacleSpeed;
            obs.display(taxiImg);

            if (collideRectRect(player.x - 25, player.y - 45, 50, 90,
                                obs.x - 25, obs.y - 45, 50, 90)) {
              gameOver = true;
              bgm.stop();
              dejavu.stop();
              if (!crashSound.isPlaying()) crashSound.play();
            }

            if (obs.y < height + 100) alive.push(obs);
          }
          obstacles = alive;

          // boosters
          let powerAlive = [];
          for (let p of powerUps) {
            p.y += obstacleSpeed * 0.8;
            p.display(boosterImg);

            if (collideRectRect(player.x - 25, player.y - 45, 50, 90,
                                p.x - 20, p.y - 20, 40, 40)) {
              boostTimer = 40;

              // Pause ONLY racingCar.mp3, dejavu continues
              if (bgm.isPlaying()) bgm.pause();

              if (!boosterSound.isPlaying()) {
                boosterSound.rate(2.0);
                boosterSound.play();
                boosterSound.onended(() => {
                  if (!musicPaused && inGame && !gameOver && !gameWin) {
                    bgm.loop(); // racingCar resumes
                  }
                });
              }
              continue;
            }

            if (p.y < height + 100) powerAlive.push(p);
          }
          powerUps = powerAlive;

          // finish line
          if (millis() - startTime > 30000 && !finishDropped) {
            finishDropped = true;
            finishLineY = -50;
          }

          if (finishDropped) {
            finishLineY += 3;
            stroke(255, 0, 0);
            strokeWeight(10);
            line(0, finishLineY, width, finishLineY);
            noStroke();

            if (finishLineY > enemy.y + 45) {
              gameOver = true;
              bgm.stop();
              dejavu.stop();
            } else if (finishLineY > player.y + 45) {
              gameWin = true;
              bgm.stop();
              dejavu.stop();
            }
          }

        } else {
          background(0); // full black when win/lose
          fill(gameOver ? 255 : 0, gameWin ? 255 : 0, 0);
          textSize(32);
          text(gameOver ? 'YOU LOSE üò¢' : 'YOU WIN üèÅ', width / 2, height / 2 - 20);
          textSize(18);
          text('Press SPACE to restart \nPress M to return to menu', width / 2, height / 2 + 20);
        }
      }

      function collideRectRect(x1, y1, w1, h1, x2, y2, w2, h2) {
        return (x1 < x2 + w2 && x1 + w1 > x2 &&
                y1 < y2 + h2 && y1 + h1 > y2);
      }

      class Car {
        constructor(x, y, col) { this.x = x; this.y = y; this.col = col; this.dir = 0; }
        update() {
          this.x += this.dir * 6;
          this.x = constrain(this.x, 40, width - 40);
          if (this === player && boostTimer > 0) {
            this.y -= 2;
            boostTimer--;
          }
        }
        display(img) {
          imageMode(CENTER);
          if (img) image(img, this.x, this.y, 60, 110);
          else { fill(this.col); rectMode(CENTER); rect(this.x, this.y, 50, 90, 10); }
        }
        move(d) { this.dir = d; }
      }

      class PowerUp {
        constructor(x, y) { this.x = x; this.y = y; }
        display(img) { imageMode(CENTER); if (img) image(img, this.x, this.y, 40, 40); else { fill(255, 255, 0); rectMode(CENTER); rect(this.x, this.y, 40, 40, 5); } }
      }

      function proAvoidObstacles() {
        const fixedY = 200;
        let moveDir = 0, dangerLeft = false, dangerRight = false;
        for (let obs of obstacles) {
          if (!obs) continue;
          if (obs.y > fixedY - 250 && obs.y < fixedY + 200) {
            if (abs(obs.x - enemy.x) < 70) {
              if (obs.x < enemy.x) dangerLeft = true;
              else dangerRight = true;
            }
          }
        }
        if (dangerLeft && !dangerRight) moveDir = 1;
        else if (dangerRight && !dangerLeft) moveDir = -1;
        else if (dangerLeft && dangerRight) moveDir = random([-1, 1]);
        else moveDir = 0;
        enemy.move(moveDir);
      }

      function resetGame() {
        obstacles = [];
        powerUps = [];
        gameOver = false;
        gameWin = false;
        finishDropped = false;
        finishLineY = -100;
        lastSpawnTime = millis();
        lastSpeedIncrease = millis();
        startTime = millis();
        obstacleSpeed = 5;
        spawnInterval = 1200;
        spawnCycle = 0;
        boostTimer = 0;
        player = new Car(width / 2, height - 80, color(0, 255, 0));
        enemy = new Car(width / 2, 200, color(255, 0, 0));
      }

      function mainMenu() {
        background(30);
        textAlign(CENTER, CENTER);

        fill(255);
        textSize(28);
        text('Main Menu', width / 2, 60);

        showButtons();
        showCustomizeButtons();

        textSize(22);
        text('Please select a car', width / 2, height / 2 - 120);

        let selectedCarName = '';
        if (currentPlayerImg === playerImg) selectedCarName = 'Skyline';
        else if (currentPlayerImg === aeImg) selectedCarName = 'AE86';
        else selectedCarName = 'GTR';

        text('The car you chose is ' + selectedCarName, width / 2, height / 2 - 90);

        push(); 
        imageMode(CENTER); 
        image(playerImg, windowWidth / 2 - 600, height / 2 + 50, 60, 110); 
        image(aeImg, windowWidth / 2 - 470, height / 2 + 50, 60, 110); 
        image(gtrImg, windowWidth / 2 - 330, height / 2 + 50, 60, 110); 
        pop();
      }

      function hideButtons() { playButton.hide(); }
      function showButtons() { playButton.show(); playButton.position(windowWidth / 2 - 40, height - 30); }
      function hideCustomizeButtons() { skinButton1.hide(); skinButton2.hide(); skinButton3.hide(); }
      function showCustomizeButtons() { skinButton1.show(); skinButton2.show(); skinButton3.show(); }

      function keyPressed() {
        if (keyCode === LEFT_ARROW) player.move(-1);
        else if (keyCode === RIGHT_ARROW) player.move(1);
        if (key === ' ' && (gameOver || gameWin)) resetGame();
        if ((key === 'm' || key === 'M') && (gameOver || gameWin)) {
          resetGame();
          showCustomizeButtons();
          inGame = false;
        }
      }

      function keyReleased() {
        if (keyCode === LEFT_ARROW || keyCode === RIGHT_ARROW) player.move(0);
      }
    </script>
  </body>
</html>
